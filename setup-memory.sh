#!/bin/bash

# üöÄ –°–∫—Ä–∏–ø—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø–∞–º—è—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞
# –ó–∞–ø—É—Å–∫–∞—Ç—å –æ—Ç root: ./setup-memory.sh

set -e

# –¶–≤–µ—Ç–∞
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m'

echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–∞–º—è—Ç–∏..."
free -h

# 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Swap (–§–∞–π–ª –ø–æ–¥–∫–∞—á–∫–∏)
# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ swap
if swapon --show | grep -q "file"; then
    echo -e "${GREEN}‚úì Swap —Ñ–∞–π–ª —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.${NC}"
else
    echo "‚öôÔ∏è –°–æ–∑–¥–∞–µ–º Swap —Ñ–∞–π–ª —Ä–∞–∑–º–µ—Ä–æ–º 4GB..."
    # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª
    fallocate -l 4G /swapfile || dd if=/dev/zero of=/swapfile bs=1M count=4096
    chmod 600 /swapfile
    mkswap /swapfile
    swapon /swapfile
    
    # –î–æ–±–∞–≤–ª—è–µ–º –≤ fstab –¥–ª—è –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∏
    echo '/swapfile none swap sw 0 0' | tee -a /etc/fstab
    
    echo -e "${GREEN}‚úì Swap —Ñ–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω.${NC}"
fi

# 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —è–¥—Ä–∞
echo "‚öôÔ∏è –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —è–¥—Ä–∞..."

# vm.swappiness = 10 (–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å RAM –ø–æ –º–∞–∫—Å–∏–º—É–º—É, –ø—Ä–µ–∂–¥–µ —á–µ–º –ª–µ–∑—Ç—å –≤ swap)
sysctl vm.swappiness=10
echo 'vm.swappiness=10' | tee -a /etc/sysctl.conf

# vm.vfs_cache_pressure = 50 (–ö—ç—à–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª—ã —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã)
sysctl vm.vfs_cache_pressure=50
echo 'vm.vfs_cache_pressure=50' | tee -a /etc/sysctl.conf

echo -e "${GREEN}‚úì –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —è–¥—Ä–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã.${NC}"

# 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
echo ""
echo "‚úÖ –ò—Ç–æ–≥–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–∞–º—è—Ç–∏:"
free -h
echo ""
echo "–¢–µ–ø–µ—Ä—å —Å–µ—Ä–≤–µ—Ä –≥–æ—Ç–æ–≤ –∫ —Ç—è–∂–µ–ª—ã–º —Å–±–æ—Ä–∫–∞–º Docker!"

