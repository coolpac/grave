# ✅ Финальная реализация брошенных корзин через Python боты

## 🎯 Что было сделано

### 1. ✅ Убрано дублирование

**Было:**
- Логика отправки уведомлений в NestJS (`TelegramBotClientService`)
- Логика отправки уведомлений в Python ботах
- Дублирование функционала

**Стало:**
- ✅ Все уведомления отправляются только через Python боты
- ✅ NestJS только вызывает Python боты через HTTP
- ✅ Единая точка отправки

### 2. ✅ Новый Python бот для автоматических напоминаний

**Файл:** `bots/abandoned_cart_bot.py`

**Функционал:**
- Автоматическая проверка брошенных корзин по расписанию (APScheduler)
- Проверка настроек из БД перед отправкой
- Учет интервала между напоминаниями
- Ограничение максимального количества напоминаний
- Отправка через Customer Bot

### 3. ✅ Endpoint в Customer Bot

**Добавлен:** `POST /notify/abandoned-cart`

Отправляет красивое HTML-сообщение с:
- Информацией о товарах в корзине
- Суммой заказа
- Количеством дней с момента брошения
- Ссылкой на корзину

### 4. ✅ Настройки в БД

**Модель:** `AbandonedCartSettings`

**API:**
- `GET /admin/abandoned-carts/settings` - получить настройки
- `POST /admin/abandoned-carts/settings` - обновить настройки

### 5. ✅ Улучшенная админка

**Новые возможности:**
- Кнопка "Настройки" для управления автоматическими напоминаниями
- Переключатель включения/выключения
- Настройка интервала (1-168 часов)
- Настройка максимального количества (1-10)
- Карточка статуса в статистике

## 🔄 Архитектура

```
┌─────────────────┐
│   NestJS API    │
│  (отслеживание  │
│  брошенных      │
│   корзин)       │
└────────┬────────┘
         │
         │ HTTP API
         │
    ┌────┴────┐
    │         │
    ▼         ▼
┌─────────┐ ┌──────────────────┐
│Customer │ │ Abandoned Cart   │
│   Bot   │ │      Bot         │
│         │ │ (автоматические  │
│         │ │  напоминания)    │
└────┬────┘ └────────┬─────────┘
     │                │
     │                │ HTTP API
     │                │
     └────────┬────────┘
              │
              ▼
      ┌──────────────┐
      │   Telegram   │
      │     API      │
      └──────────────┘
```

## 📋 Процесс работы

### Автоматические напоминания

1. **Abandoned Cart Bot запускается** (каждый час)
2. **Проверяет настройки** из API
3. **Если включено:**
   - Получает список брошенных корзин
   - Фильтрует по условиям
   - Для каждой корзины:
     - Получает детали
     - Отправляет через Customer Bot
     - Отмечает как отправленное

### Ручная отправка

1. Администратор нажимает "Отправить напоминание"
2. NestJS вызывает Customer Bot напрямую
3. Customer Bot отправляет в Telegram

## ⚙️ Настройка

### 1. Установка зависимостей

```bash
cd bots
pip install -r requirements.txt
```

### 2. Переменные окружения

Создайте `bots/.env`:

```env
# Customer Bot
CUSTOMER_BOT_TOKEN=your_token
PORT=8001

# Admin Bot
ADMIN_BOT_TOKEN=your_token
ADMIN_CHAT_ID=your_chat_id
PORT=8002

# Abandoned Cart Bot
API_URL=http://localhost:3000/api
CUSTOMER_BOT_API_URL=http://localhost:8001
ABANDONED_CART_CHECK_INTERVAL_HOURS=1
REMINDER_INTERVAL_HOURS=24
MAX_REMINDERS=3
```

### 3. Запуск

```bash
cd bots
./start_bots.sh
```

Или по отдельности:
```bash
python3 customer_bot.py &
python3 admin_bot.py &
python3 abandoned_cart_bot.py &
```

## 🎛️ Управление через админку

1. Откройте `/abandoned-carts` в админке
2. Нажмите "Настройки"
3. Включите "Автоматические напоминания"
4. Настройте параметры:
   - Интервал между напоминаниями (часы)
   - Максимальное количество напоминаний
5. Сохранение происходит автоматически

## 📊 Преимущества

1. **Единая точка отправки** - все через Python боты
2. **Автоматизация** - не нужно вручную отправлять
3. **Гибкость** - легко настроить параметры
4. **Масштабируемость** - можно запускать на отдельном сервере
5. **Независимость** - падение бота не влияет на API

## ✅ Готово к использованию

Все готово:
- ✅ Python боты настроены
- ✅ Автоматические напоминания работают
- ✅ Админка для управления
- ✅ Документация создана
- ✅ Дублирование убрано

