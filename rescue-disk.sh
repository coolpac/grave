#!/bin/bash

# üöë –°–∫—Ä–∏–ø—Ç —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–≥–æ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –º–µ—Å—Ç–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Swap
# –ó–∞–ø—É—Å–∫–∞—Ç—å –æ—Ç root: ./rescue-disk.sh

set -e

# –¶–≤–µ—Ç–∞
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∏—Å–∫–∞ –î–û –æ—á–∏—Å—Ç–∫–∏:"
df -h /

# 1. –£–¥–∞–ª–µ–Ω–∏–µ "–±–∏—Ç–æ–≥–æ" swap —Ñ–∞–π–ª–∞
if [ -f /swapfile ]; then
    echo "üóëÔ∏è –£–¥–∞–ª—è–µ–º –Ω–µ–¥–æ–ø–∏—Å–∞–Ω–Ω—ã–π /swapfile..."
    swapoff /swapfile 2>/dev/null || true
    rm -f /swapfile
    # –£–¥–∞–ª—è–µ–º –∏–∑ fstab –µ—Å–ª–∏ –µ—Å—Ç—å
    sed -i '/\/swapfile/d' /etc/fstab
fi

# 2. –û—á–∏—Å—Ç–∫–∞ Docker (—Å–∞–º–æ–µ –∂–∏—Ä–Ω–æ–µ)
echo "üê≥ –û—á–∏—Å—Ç–∫–∞ Docker (—É–¥–∞–ª—è–µ–º –≤—Å—ë –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–µ)..."
# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã, —á—Ç–æ–±—ã —Ç–æ—á–Ω–æ –≤—Å—ë —É–¥–∞–ª–∏—Ç—å
docker stop $(docker ps -q) 2>/dev/null || true
# –£–¥–∞–ª—è–µ–º –≤—Å—ë: –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã, —Å–µ—Ç–∏, –æ–±—Ä–∞–∑—ã (–≤—Å–µ!), –∫—ç—à —Å–±–æ—Ä–∫–∏
docker system prune -a --volumes -f

# 3. –û—á–∏—Å—Ç–∫–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –º—É—Å–æ—Ä–∞
echo "üßπ –û—á–∏—Å—Ç–∫–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –∫—ç—à–∞..."
apt-get clean
rm -rf /var/lib/apt/lists/*
journalctl --vacuum-time=1d # –û—Å—Ç–∞–≤–ª—è–µ–º –ª–æ–≥–∏ —Ç–æ–ª—å–∫–æ –∑–∞ 1 –¥–µ–Ω—å
rm -rf /tmp/*
rm -rf /var/tmp/*

echo "üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∏—Å–∫–∞ –ü–û–°–õ–ï –æ—á–∏—Å—Ç–∫–∏:"
df -h /

# 4. –°–æ–∑–¥–∞–Ω–∏–µ "–õ–µ–≥–∫–æ–≥–æ" Swap (2GB –≤–º–µ—Å—Ç–æ 4GB)
# –ù–∞ –¥–∏—Å–∫–µ 13GB –¥–µ–ª–∞—Ç—å swap 4GB - —ç—Ç–æ —Ä–æ—Å–∫–æ—à—å. 2GB —Ö–≤–∞—Ç–∏—Ç –¥–ª—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π —Å–±–æ—Ä–∫–∏.
echo "‚öôÔ∏è –°–æ–∑–¥–∞–µ–º –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π Swap —Ñ–∞–π–ª (2GB)..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ
AVAILABLE_KB=$(df / | awk 'NR==2 {print $4}')
if [ "$AVAILABLE_KB" -lt 2500000 ]; then
    echo -e "${RED}‚ùå –û–®–ò–ë–ö–ê: –°–≤–æ–±–æ–¥–Ω–æ –º–µ–Ω–µ–µ 2.5GB. –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å Swap.${NC}"
    echo "–û—Å–≤–æ–±–æ–¥–∏—Ç–µ –º–µ—Å—Ç–æ –≤—Ä—É—á–Ω—É—é –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —Å–Ω–æ–≤–∞."
    exit 1
fi

fallocate -l 2G /swapfile || dd if=/dev/zero of=/swapfile bs=1M count=2048
chmod 600 /swapfile
mkswap /swapfile
swapon /swapfile

# –î–æ–±–∞–≤–ª—è–µ–º –≤ fstab
if ! grep -q "/swapfile" /etc/fstab; then
    echo '/swapfile none swap sw 0 0' | tee -a /etc/fstab
fi

# 5. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —è–¥—Ä–∞ (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ)
echo "‚öôÔ∏è –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —è–¥—Ä–∞..."
sysctl vm.swappiness=10
sysctl vm.vfs_cache_pressure=50

# –ï—Å–ª–∏ –Ω–µ—Ç –≤ –∫–æ–Ω—Ñ–∏–≥–µ, –¥–æ–±–∞–≤–ª—è–µ–º
if ! grep -q "vm.swappiness" /etc/sysctl.conf; then
    echo 'vm.swappiness=10' | tee -a /etc/sysctl.conf
    echo 'vm.vfs_cache_pressure=50' | tee -a /etc/sysctl.conf
fi

echo ""
echo -e "${GREEN}‚úÖ –°–µ—Ä–≤–µ—Ä —Å–ø–∞—Å–µ–Ω!${NC}"
echo "–ü–∞–º—è—Ç—å:"
free -h
echo "–î–∏—Å–∫:"
df -h /

