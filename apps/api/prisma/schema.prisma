// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum ProductType {
  SIMPLE // Простой товар с фиксированной ценой
  SINGLE_VARIANT // Один атрибут (размер)
  MATRIX // Матрица атрибутов (размер × сорт)
  RANGE // Диапазоны размеров
  CONFIGURABLE // Сложная конфигурация
}

enum UnitType {
  PIECE // шт
  SQUARE_METER // м²
  TON // Т
  SET // компл
}

model User {
  id           Int      @id @default(autoincrement())
  telegramId   BigInt   @unique
  firstName    String
  lastName     String?
  username     String?
  languageCode String?
  isPremium    Boolean  @default(false)
  photoUrl     String?
  role         UserRole @default(USER)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  carts          Cart[]
  orders         Order[]
  abandonedCarts AbandonedCart[]

  @@index([telegramId])
  @@map("users")
}

model Category {
  id          Int      @id @default(autoincrement())
  slug        String   @unique
  name        String
  description String?
  image       String?
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  products Product[]

  @@index([slug])
  @@index([isActive])
  @@map("categories")
}

model Product {
  id          Int         @id @default(autoincrement())
  slug        String      @unique
  name        String
  description String?
  categoryId  Int
  productType ProductType @default(SIMPLE)
  basePrice   Decimal?    @db.Decimal(10, 2) // Для SIMPLE товаров
  unit        UnitType    @default(PIECE)
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  category   Category           @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  attributes ProductAttribute[]
  variants   ProductVariant[]
  media      ProductMedia[]
  cartItems  CartItem[]

  @@index([slug])
  @@index([categoryId])
  @@index([isActive])
  @@index([productType])
  @@map("products")
}

model ProductAttribute {
  id         Int     @id @default(autoincrement())
  productId  Int
  name       String // "Размер", "Сорт", "Высота", "Диаметр"
  slug       String // "size", "grade", "height", "diameter"
  type       String  @default("select") // "size", "select", "number", "range"
  order      Int     @default(0)
  isRequired Boolean @default(true)
  unit       String? // "мм", "м²", "кг"

  product Product                 @relation(fields: [productId], references: [id], onDelete: Cascade)
  values  ProductAttributeValue[]

  @@index([productId])
  @@map("product_attributes")
}

model ProductAttributeValue {
  id          Int    @id @default(autoincrement())
  attributeId Int
  value       String // "300*300*15", "сорт 1", "70"
  displayName String // "300×300×15 мм", "Сорт 1", "70 мм"
  order       Int    @default(0)
  metadata    Json? // Дополнительные данные (вес, диапазоны)

  attribute ProductAttribute @relation(fields: [attributeId], references: [id], onDelete: Cascade)

  @@index([attributeId])
  @@map("product_attribute_values")
}

model ProductVariant {
  id        Int      @id @default(autoincrement())
  productId Int
  name      String? // Для обратной совместимости
  sku       String?  @unique
  price     Decimal  @db.Decimal(10, 2)
  stock     Int      @default(0)
  weight    Decimal? @db.Decimal(10, 2) // Для стел с весом
  unit      UnitType @default(PIECE)
  isActive  Boolean  @default(true)
  metadata  Json? // Дополнительные данные (размеры, характеристики)

  // JSON структура для хранения комбинации атрибутов
  // Пример: { "size": "300*300*15", "grade": "1" }
  attributes Json @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product    Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  cartItems  CartItem[]
  orderItems OrderItem[]

  @@index([productId])
  @@index([sku])
  @@map("product_variants")
}

model ProductMedia {
  id        Int      @id @default(autoincrement())
  productId Int
  url       String
  type      String   @default("image") // image, video
  order     Int      @default(0)
  createdAt DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("product_media")
}

model Cart {
  id        Int      @id @default(autoincrement())
  userId    Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user  User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items CartItem[]

  @@unique([userId])
  @@index([userId])
  @@map("carts")
}

model CartItem {
  id                 Int      @id @default(autoincrement())
  cartId             Int
  productId          Int
  variantId          Int?
  quantity           Int      @default(1)
  // JSON структура для хранения выбранных атрибутов (для отображения в корзине)
  selectedAttributes Json?    @default("{}")
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  cart    Cart            @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)

  @@index([cartId])
  @@index([productId])
  @@map("cart_items")
}

model Order {
  id              Int           @id @default(autoincrement())
  userId          Int
  orderNumber     String        @unique
  status          OrderStatus   @default(PENDING)
  paymentStatus   PaymentStatus @default(PENDING)
  total           Decimal       @db.Decimal(10, 2)
  customerName    String
  customerPhone   String
  customerEmail   String?
  customerAddress String
  comment         String?
  paymentId       String?
  paymentData     Json?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  user  User        @relation(fields: [userId], references: [id])
  items OrderItem[]

  @@index([userId])
  @@index([orderNumber])
  @@index([status])
  @@index([paymentStatus])
  @@map("orders")
}

model OrderItem {
  id                 Int      @id @default(autoincrement())
  orderId            Int
  productId          Int
  variantId          Int?
  productName        String
  variantName        String?
  price              Decimal  @db.Decimal(10, 2)
  quantity           Int
  // JSON структура для хранения выбранных атрибутов (для истории заказов)
  selectedAttributes Json?    @default("{}")
  createdAt          DateTime @default(now())

  order   Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  variant ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

model Banner {
  id          Int       @id @default(autoincrement())
  title       String
  description String?
  imageUrl    String
  linkUrl     String?
  position    String   @default("home") // home, category, product
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  startDate   DateTime?
  endDate     DateTime?
  clickCount  Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive])
  @@index([position])
  @@map("banners")
}

model Newsletter {
  id          Int       @id @default(autoincrement())
  subject     String
  content     String   @db.Text
  htmlContent String?  @db.Text
  status      String   @default("draft") // draft, scheduled, sending, sent, cancelled
  scheduledAt DateTime?
  sentAt      DateTime?
  recipientCount Int   @default(0)
  openedCount Int      @default(0)
  clickedCount Int     @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([status])
  @@index([scheduledAt])
  @@map("newsletters")
}

model AbandonedCart {
  id          Int       @id @default(autoincrement())
  userId      Int
  cartId      Int
  itemsCount  Int
  totalAmount Decimal   @db.Decimal(10, 2)
  reminderSent Int      @default(0) // Количество отправленных напоминаний
  lastReminderAt DateTime?
  recovered   Boolean   @default(false) // Восстановлена ли корзина
  recoveredAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([cartId])
  @@index([userId])
  @@index([recovered])
  @@index([createdAt])
  @@map("abandoned_carts")
}
