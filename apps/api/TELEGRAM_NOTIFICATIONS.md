# üì± Telegram Notifications System

–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ —Å–∏—Å—Ç–µ–º–µ Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —á–µ—Ä–µ–∑ Bull Queue.

---

## üéØ –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **Bull Queue** –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —á–µ—Ä–µ–∑ **Python –±–æ—Ç—ã**:

- **Customer Bot** - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞–º
- **Admin Bot** - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**
```
NestJS API ‚Üí Bull Queue ‚Üí TelegramNotificationProcessor ‚Üí Python Bots ‚Üí Telegram
```

---

## üì¨ –¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### 1. Order Created (–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞)

**–ö–æ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è:**
- –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –∑–∞–∫–∞–∑–∞

**–ü–æ–ª—É—á–∞—Ç–µ–ª–∏:**
- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä (–≤—Å–µ–≥–¥–∞)
- –ö–ª–∏–µ–Ω—Ç (–µ—Å–ª–∏ –µ—Å—Ç—å telegramId)

**–ü—Ä–∏–º–µ—Ä:**

```typescript
await telegramNotificationQueue.addNotificationJob({
  type: 'order_created',
  recipient: 'both',
  telegramId: user.telegramId.toString(),
  data: {
    orderNumber: 'ORD-123',
    orderId: 123,
    customerName: '–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤',
    total: 5000,
    items: [...],
  },
  priority: 'high',
});
```

---

### 2. Order Status Changed (–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞)

**–ö–æ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è:**
- –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞ (PENDING ‚Üí CONFIRMED, CONFIRMED ‚Üí PROCESSING, etc.)

**–ü–æ–ª—É—á–∞—Ç–µ–ª–∏:**
- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
- –ö–ª–∏–µ–Ω—Ç (–µ—Å–ª–∏ –µ—Å—Ç—å telegramId)

**–ü—Ä–∏–º–µ—Ä:**

```typescript
await telegramNotificationQueue.addNotificationJob({
  type: 'order_status_changed',
  recipient: 'both',
  telegramId: user.telegramId.toString(),
  data: {
    orderNumber: 'ORD-123',
    oldStatus: 'PENDING',
    newStatus: 'CONFIRMED',
    customerName: '–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤',
  },
  priority: 'normal',
});
```

---

### 3. Cart Abandoned (–ë—Ä–æ—à–µ–Ω–Ω–∞—è –∫–æ—Ä–∑–∏–Ω–∞)

**–ö–æ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ cron job (–∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤)
- –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±—Ä–æ—à–µ–Ω–Ω–æ–π –∫–æ—Ä–∑–∏–Ω—ã

**–ü–æ–ª—É—á–∞—Ç–µ–ª–∏:**
- –¢–æ–ª—å–∫–æ –∫–ª–∏–µ–Ω—Ç (—Ç—Ä–µ–±—É–µ—Ç—Å—è telegramId)

**–ü—Ä–∏–º–µ—Ä:**

```typescript
await telegramNotificationQueue.addNotificationJob({
  type: 'cart_abandoned',
  recipient: 'customer',
  telegramId: user.telegramId.toString(),
  data: {
    cartId: 456,
    totalAmount: 3000,
    itemsCount: 3,
  },
  priority: 'normal',
});
```

---

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Python –±–æ—Ç–æ–≤

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Python 3.8+
- –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (—Å–º. `bots/requirements.txt`)
- Telegram Bot Tokens (–æ—Ç @BotFather)

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```env
# Customer Bot
CUSTOMER_BOT_API_URL=http://localhost:8001

# Admin Bot
ADMIN_BOT_API_URL=http://localhost:8002
```

### –ó–∞–ø—É—Å–∫ –±–æ—Ç–æ–≤

```bash
# Customer Bot
cd bots
python customer_bot.py

# Admin Bot
python admin_bot.py
```

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### Bull Board

**URL:** http://localhost:3000/admin/queues

**–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—á–µ—Ä–µ–¥–∏:**
- `waiting` - –û–∂–∏–¥–∞—é—â–∏–µ –∑–∞–¥–∞—á–∏
- `active` - –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏
- `completed` - –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
- `failed` - –ù–µ—É–¥–∞—á–Ω—ã–µ –∑–∞–¥–∞—á–∏
- `delayed` - –û—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### API Endpoint

```bash
GET /api/admin/queues/stats
```

**Response:**
```json
{
  "telegram": {
    "waiting": 5,
    "active": 2,
    "completed": 100,
    "failed": 3,
    "delayed": 1
  }
}
```

---

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã

- **high** (10) - –ö—Ä–∏—Ç–∏—á–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (—Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞)
- **normal** (5) - –û–±—ã—á–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞)
- **low** (1) - –ù–∏–∑–∫–æ–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

### Retry Policy

- **Attempts:** 3 –ø–æ–ø—ã—Ç–∫–∏
- **Backoff:** Exponential (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 2 —Å–µ–∫—É–Ω–¥)
- **Max Stalled Count:** 1

### Cleanup

- **Completed jobs:** –•—Ä–∞–Ω—è—Ç—Å—è 1 —á–∞—Å (–º–∞–∫—Å. 1000)
- **Failed jobs:** –•—Ä–∞–Ω—è—Ç—Å—è 24 —á–∞—Å–∞ (–º–∞–∫—Å. 5000)

---

## üîÑ Cron Jobs

### –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –æ –±—Ä–æ—à–µ–Ω–Ω—ã—Ö –∫–æ—Ä–∑–∏–Ω–∞—Ö

**–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:** –ö–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤ (`0 */6 * * *`)

**–õ–æ–≥–∏–∫–∞:**
1. –ù–∞—Ö–æ–¥–∏—Ç –±—Ä–æ—à–µ–Ω–Ω—ã–µ –∫–æ—Ä–∑–∏–Ω—ã (–Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–∏—Å—å >24 —á–∞—Å–æ–≤)
2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –∫–æ—Ä–∑–∏–Ω–∞ –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
3. –î–æ–±–∞–≤–ª—è–µ—Ç –∑–∞–¥–∞—á–∏ –≤ –æ—á–µ—Ä–µ–¥—å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π

---

## üö® Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω—ã:**
1. Python –±–æ—Ç—ã –Ω–µ –∑–∞–ø—É—â–µ–Ω—ã
2. –ù–µ–≤–µ—Ä–Ω—ã–π `CUSTOMER_BOT_API_URL` –∏–ª–∏ `ADMIN_BOT_API_URL`
3. –ë–æ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º (403 –æ—à–∏–±–∫–∞)

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å –±–æ—Ç–æ–≤: `curl http://localhost:8001/health`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Python –±–æ—Ç–æ–≤
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Bull Board –¥–ª—è failed jobs

---

### –ü—Ä–æ–±–ª–µ–º–∞: –ó–∞–¥–∞—á–∏ –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è –≤ –æ—á–µ—Ä–µ–¥–∏

**–ü—Ä–∏—á–∏–Ω—ã:**
1. Python –±–æ—Ç—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã
2. –ú–µ–¥–ª–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞

**–†–µ—à–µ–Ω–∏–µ:**
1. –£–≤–µ–ª–∏—á—å—Ç–µ concurrency –≤ processor (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 5)
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Python –±–æ—Ç–æ–≤
3. –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –º–µ—Ç—Ä–∏–∫–∏ –≤ Bull Board

---

### –ü—Ä–æ–±–ª–µ–º–∞: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

**–ü—Ä–∏—á–∏–Ω—ã:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±–æ—Ç–∞
2. –ù–µ–≤–µ—Ä–Ω—ã–π telegramId
3. –ë–æ—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ telegramId –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
2. –ü–æ–ø—Ä–æ—Å–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –±–æ—Ç–∞
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Python –±–æ—Ç–∞

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [Telegram Bot API](https://core.telegram.org/bots/api)
- [Bull Queue Documentation](https://github.com/OptimalBits/bull)
- [Python Telegram Bot](https://python-telegram-bot.org/)

---

**Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è - –±—ã—Å—Ç—Ä—ã–π –∏ –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–± —Å–≤—è–∑–∏ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏! üì±**

