# üìú Database Scripts

–£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö.

## üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã

### üîÑ `migrate-to-postgresql.sh`

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –º–∏–≥—Ä–∞—Ü–∏—è —Å SQLite –Ω–∞ PostgreSQL.

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```bash
export DATABASE_URL="postgresql://postgres:password@localhost:5432/ritual_db?schema=public"
./scripts/migrate-to-postgresql.sh
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- ‚úÖ –°–æ–∑–¥–∞–µ—Ç backup SQLite –±–∞–∑—ã
- ‚úÖ –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç —Å—Ö–µ–º—É –Ω–∞ PostgreSQL
- ‚úÖ –°–æ–∑–¥–∞–µ—Ç –∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç –º–∏–≥—Ä–∞—Ü–∏—é
- ‚úÖ –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç seed

---

### üíæ `backup-db.sh`

–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ PostgreSQL –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```bash
# –° –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –∏–º–µ–Ω–µ–º
./scripts/backup-db.sh

# –° –∫–∞—Å—Ç–æ–º–Ω—ã–º –∏–º–µ–Ω–µ–º
./scripts/backup-db.sh my_backup_name
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `BACKUP_DIR` - –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è backups (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: `./backups`)
- `RETENTION_DAYS` - —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π —Ö—Ä–∞–Ω–∏—Ç—å backups (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 30)

**–ü—Ä–∏–º–µ—Ä:**
```bash
BACKUP_DIR=/var/backups RETENTION_DAYS=60 ./scripts/backup-db.sh
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –°–æ–∑–¥–∞–µ—Ç —Å–∂–∞—Ç—ã–π backup: `backups/backup_YYYYMMDD_HHMMSS.sql.gz`
- –°–æ–∑–¥–∞–µ—Ç —Å–∏–º–ª–∏–Ω–∫: `backups/latest.sql.gz`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ backups

---

### üîÑ `restore-db.sh`

–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏–∑ backup.

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```bash
./scripts/restore-db.sh backups/backup_20241120_120000.sql.gz
```

**‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï:** 
- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ **–ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç** —Ç–µ–∫—É—â—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å –µ—Å—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–π backup –ø–µ—Ä–µ–¥ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
2. –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ—Ç backup (–µ—Å–ª–∏ —Å–∂–∞—Ç)
3. –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ
4. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏

---

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–í—Å–µ —Å–∫—Ä–∏–ø—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç `DATABASE_URL` –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:

```bash
# –í–∞—Ä–∏–∞–Ω—Ç 1: DATABASE_URL
export DATABASE_URL="postgresql://user:pass@host:port/db"

# –í–∞—Ä–∏–∞–Ω—Ç 2: –û—Ç–¥–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
export POSTGRES_HOST=localhost
export POSTGRES_PORT=5432
export POSTGRES_USER=postgres
export POSTGRES_PASSWORD=password
export POSTGRES_DB=ritual_db
```

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ backups

–ù–∞—Å—Ç—Ä–æ–π—Ç–µ cron –¥–ª—è —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö backups:

```bash
# –û—Ç–∫—Ä–æ–π—Ç–µ crontab
crontab -e

# –î–æ–±–∞–≤—å—Ç–µ —Å—Ç—Ä–æ–∫—É (backup –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 2:00 AM)
0 2 * * * cd /path/to/apps/api && ./scripts/backup-db.sh >> /var/log/db-backup.log 2>&1
```

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ backups

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö backups

```bash
ls -lh backups/*.sql.gz | tail -5
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ backups

```bash
du -sh backups/
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ backup

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∂–∞—Ç–æ–≥–æ —Ñ–∞–π–ª–∞
gunzip -t backups/backup_20241120_120000.sql.gz

# –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ (–±–µ–∑ —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∏)
zcat backups/backup_20241120_120000.sql.gz | head -20
```

---

## üö® Troubleshooting

### –û—à–∏–±–∫–∞: "pg_dump: command not found"

**–†–µ—à–µ–Ω–∏–µ:** –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ PostgreSQL client tools:
```bash
# macOS
brew install postgresql

# Ubuntu/Debian
sudo apt-get install postgresql-client

# Docker
docker exec -it ritual_postgres pg_dump ...
```

### –û—à–∏–±–∫–∞: "Permission denied"

**–†–µ—à–µ–Ω–∏–µ:** –°–¥–µ–ª–∞–π—Ç–µ —Å–∫—Ä–∏–ø—Ç—ã –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º–∏:
```bash
chmod +x scripts/*.sh
```

### –û—à–∏–±–∫–∞: "Database connection failed"

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `DATABASE_URL`:
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
psql $DATABASE_URL -c "SELECT 1;"
```

---

## üìù Best Practices

1. **–†–µ–≥—É–ª—è—Ä–Ω—ã–µ backups:** –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ backups —á–µ—Ä–µ–∑ cron
2. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:** –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ, —á—Ç–æ backups –º–æ–∂–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
3. **–•—Ä–∞–Ω–µ–Ω–∏–µ:** –•—Ä–∞–Ω–∏—Ç–µ backups –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º –º–µ—Å—Ç–µ (–Ω–µ —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ)
4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –ª–æ–≥–∏ backups –Ω–∞ –æ—à–∏–±–∫–∏
5. **–†–æ—Ç–∞—Ü–∏—è:** –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π `RETENTION_DAYS` –¥–ª—è –≤–∞—à–∏—Ö –Ω—É–∂–¥

---

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [POSTGRESQL_MIGRATION.md](../POSTGRESQL_MIGRATION.md) - –ü–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –º–∏–≥—Ä–∞—Ü–∏–∏
- [README.md](../README.md) - –û—Å–Ω–æ–≤–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API

